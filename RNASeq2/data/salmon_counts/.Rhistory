library(DESeq2)
library(tximport)
library(readr)
library("RColorBrewer")
library("gplots")
setwd("../data/salmon_counts")
#setwd("../data/salmon_counts")
# This will differ for you!!!
# Setting it up for the import (this is not the import itself)
quant_files <- file.path("quants", list.files("quants"), "quant.sf")
# Let's take a look at this variable we have created
quant_files
# Names of samples.
samples <- c("ORE_sdE3_rep1", "ORE_sdE3_rep2", "ORE_wt_rep1","ORE_wt_rep2", "HYB_sdE3_rep1", "HYB_wt_rep1", "SAM_sdE3_rep1","SAM_sdE3_rep2", "SAM_wt_rep1","SAM_wt_rep2", "HYB_sdE3_rep2", "HYB_wt_rep2")
names(quant_files) <- samples
tx2gene <- read.table("txp_to_gene.tsv", col.names=c("TXNAME", "GENEID"))
head(tx2gene)
length(table(tx2gene$TXNAME))
length(table(tx2gene$GENEID))
txi <- tximport(quant_files,
type = "salmon",
tx2gene = tx2gene,
reader = read_tsv)
# Let's also take a quick look at txi
summary(txi) # why 166884
str(txi)
head(txi$counts) # note these are not integers!
# We can look at patterns of correlations among samples
cor(txi$counts)
pairs(txi$counts[,1:2])
background <- c(rep("ORE", 4), rep("HYB", 2), rep("SAM", 4), rep("HYB", 2))
genotype <- c("sdE3", "sdE3", "wt", "wt", "sdE3", "wt", "sdE3", "sdE3", "wt", "wt", "sdE3", "wt")
lane <- c(4,5,1,2,2,6,6,7,3,4,1,5)
lane <- factor(lane) # we will want to treat this as a factor
rna.design <- data.frame(sample=samples,
file=quant_files,
background=background,
genotype=genotype,
lane = lane)
rna.design
# and we can start with a simple model (back to this later)
load.model <- formula(~ genotype)
all.data <- DESeqDataSetFromTximport(txi, rna.design, design=load.model)
load.model <- formula(~ lane)
test_lane_effects <- DESeqDataSetFromTximport(txi,
rna.design, design=load.model)
test_lane_effects2 <- DESeq(test_lane_effects)
# We now fit the simple model
test_lane_effects2_results <- results(test_lane_effects2, alpha = 0.05)
# alpha = 0.05 is the  "cut-off" for significance (not really - I will discuss).
summary(test_lane_effects2_results)
# 2 genes which may show  evidence of lane effects, but this is a bit incomplete for the full data set.
head(test_lane_effects2_results)
# let's re-order the data to look at the two genes.
test_lane_effects2_results <- test_lane_effects2_results[order(test_lane_effects2_results$padj),]
test_lane_effects2_results <- test_lane_effects2_results[order(test_lane_effects2_results$padj),]
plotDispEsts(test_lane_effects2)
for_pca <- rlog(test_lane_effects2, blind=TRUE)
dim(for_pca)
plotPCA(for_pca, intgroup=c("lane"))
plotPCA(for_pca, ntop = 2000, intgroup=c("lane"))
plotPCA(for_pca, intgroup=c("genotype", "background"))
rlogMat <- assay(for_pca) # just making a matrix of the counts that have been corrected for over-dispersion in a "blind" fashion
distsRL <- dist(t(rlogMat)) # Computes a distance matrix (Euclidian Distance)
mat <- as.matrix(distsRL)  # Make sure it is a matrix
rownames(mat) <- colnames(mat) <-   with(colData(test_lane_effects2), paste(genotype, background, sep=" : "))
hc <- hclust(distsRL)  # performs hierarchical clustering
hmcol <- colorRampPalette(brewer.pal(9, "GnBu"))(100)  # picking our colours
heatmap.2(mat, Rowv=as.dendrogram(hc),
symm=TRUE, trace="none",
col = rev(hmcol), margin=c(13, 13))
heatmap.2(mat, Rowv=as.dendrogram(hc),
symm=TRUE, trace="none",
col = rev(hmcol), margin=c(13, 13))
heatmap.2(mat, Rowv=as.dendrogram(hc),
symm=TRUE, trace="none",
col = rev(hmcol), margin=c(13, 13))
rownames(mat) <- colnames(mat) <-   with(colData(test_lane_effects2), paste(genotype, background, sep=" : "))
hc <- hclust(distsRL)  # performs hierarchical clustering
hmcol <- colorRampPalette(brewer.pal(9, "GnBu"))(100)  # picking our colours
heatmap.2(mat, Rowv=as.dendrogram(hc),
symm=TRUE, trace="none",
col = rev(hmcol), margin=c(13, 13))
?hclust
load.model <- formula(~ genotype)
test_genotype_effects <- DESeqDataSetFromTximport(txi,
rna.design, design=load.model)
test_genotype_effects2 <- DESeq(test_genotype_effects)
plotDispEsts(test_genotype_effects2)
plotMA(test_genotype_effects2, ylim =c(-2, 2))
genotype_results <- results(test_genotype_effects2,
alpha = 0.05)
print(genotype_results)
summary(genotype_results)
# reorder
genotype_results <- genotype_results[order(genotype_results$padj),]
genotype_results[1:10,]
load.model <- formula(~ lane + background + genotype) # Let me go over the matrix rank issue here
test_G <- DESeqDataSetFromTximport(txi,
rna.design, design=load.model)
test_G_2 <- DESeq(test_G)
plotDispEsts(test_G_2)
plotMA(test_G_2, ylim =c(-2, 2))
G_results <- results(test_G_2, alpha = 0.05, pAdjustMethod="BH")
summary(G_results)
# reorder
G_results <- G_results[order(G_results$padj),]
G_results[1:10,]
G_results[1:10,]
load.model <- formula(~ lane + background + genotype + genotype:background) # Let me go over the matrix rank issue here
test_GxB_effects <- DESeqDataSetFromTximport(txi,
rna.design, design=load.model)
test_GxB_effects2 <- DESeq(test_GxB_effects)
plotDispEsts(test_GxB_effects2)
plotMA(test_GxB_effects2, ylim =c(-2, 2))
GxB_results <- results(test_GxB_effects2, alpha = 0.05, pAdjustMethod="BH")
summary(GxB_results)
# reorder
GxB_results <- GxB_results[order(GxB_results$padj),]
GxB_results[1:14,]
load.model <- formula(~ lane + background + genotype + genotype:background) # Let me go over the matrix rank issue here
test_GxB_effects <- DESeqDataSetFromTximport(txi,
rna.design, design=load.model)
test_GxB_effects2 <- DESeq(test_GxB_effects)
plotDispEsts(test_GxB_effects2)
plotMA(test_GxB_effects2, ylim =c(-2, 2))
GxB_results <- results(test_GxB_effects2, alpha = 0.05, pAdjustMethod="BH")
summary(GxB_results)
# reorder
GxB_results <- GxB_results[order(GxB_results$padj),]
GxB_results[1:14,]
load.model <- formula(~ lane + background + genotype + genotype:background)
test_GxB_effects <- DESeqDataSetFromTximport(txi,
rna.design, design=load.model)
test_GxB_effects2 <- DESeq(test_GxB_effects)
load.model <- formula(~ background + genotype + genotype:background) # Let me go over the matrix rank issue here
test_GxB_effects <- DESeqDataSetFromTximport(txi,
rna.design, design=load.model)
test_GxB_effects2 <- DESeq(test_GxB_effects)
plotDispEsts(test_GxB_effects2)
plotMA(test_GxB_effects2, ylim =c(-2, 2))
GxB_results <- results(test_GxB_effects2, alpha = 0.05, pAdjustMethod="BH")
summary(GxB_results)
# reorder
GxB_results <- GxB_results[order(GxB_results$padj),]
GxB_results[1:14,]
plotMA(test_GxB_effects2, ylim =c(-4, 4))
summary(GxB_results)
GxB_results <- GxB_results[order(GxB_results$padj),]
GxB_results[1:14,]
p_fake <- rbeta(12627, 1,1) # you could also use runif(12627,1,1)
hist(p_fake)
hist(p_fake)
hist(GxB_results$pvalue)
res_contrast_genotype <- results(test_GxB_effects2,
contrast=c("genotype", "wt", "sdE3"),
pAdjustMethod="BH")
summary(res_contrast_genotype, alpha= 0.05)
]
attr(test_GxB_effects2, "modelMatrixType")   # how is it setting up the design matrix.
#Type of model matrix, expanded or treatment contrast. For more complex models this is very important to understand.
res_contrast_genotype <- res_contrast_genotype[order(res_contrast_genotype$padj),]
res_contrast_genotype[1:10,]
summary(res_contrast_genotype, alpha= 0.05)
attr(test_GxB_effects2, "modelMatrixType")   # how is it setting up the design matrix.
res_contrast_genotype <- res_contrast_genotype[order(res_contrast_genotype$padj),]
res_contrast_genotype[1:10,]
